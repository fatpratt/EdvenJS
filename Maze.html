<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Canvas Test</title>
        <script type="text/javascript" src="MazeGlobals.js"></script>
        <script type="text/javascript" src="Trig.js"></script>
        <script type="text/javascript" src="Dest.js"></script>
        <script type="text/javascript" src="Trap.js"></script>
        <script type="text/javascript" src="GeneralConfig.js"></script>
        <script type="text/javascript" src="MazeConfig.js"></script>
        <script type="text/javascript" src="TextAreaBox.js"></script>
        <script type="text/javascript" src="MathUtils.js"></script>
        <script type="text/javascript" src="ImageCanvas.js"></script>
        <script type="text/javascript" src="IniFile.js"></script>
        <script type="text/javascript" src="MapData.js"></script>
        <script type="text/javascript" src="Maze.js"></script>
        <script type="text/javascript" src="Background.js"></script>
		<script type="text/javascript" src="WallHitItem.js"></script>
        <!--[if IE]><script language="javascript" type="text/javascript" src="excanvas.min.js"></script><![endif]-->

    </head>
    <body onload="init()">
        <section>
            <span>Id: <input id="mazeId" type="text" size="12" value="xtdubx3389"/> <input type="button" value="Change" onclick="changeMaze();"></span>
            <div id="targetCanvasDiv"></div>
            <div>
                <canvas id="canvas" width="640" height="200">
                    This text is displayed if your browser does not support HTML5 Canvas.
                </canvas>
            </div>

            <script type="text/javascript">

                var maze = null;

                //--------------------------------------------------------------------------------------------------
                // Add support for those browsers that don't support "forEach" (such as older internet explorer).
                //--------------------------------------------------------------------------------------------------
                (function () {
                    if (!Array.prototype.forEach) {
                        Array.prototype.forEach = function(fun /*, thisp*/) {
                            var len = this.length;
                            if (typeof fun != "function")
                                throw new TypeError();

                            var thisp = arguments[1];
                            for (var i = 0; i < len; i++) {
                                if (i in this)
                                        fun.call(thisp, this[i], i, this);
                            }
                        };
                    }
                }());

                //--------------------------------------------------------------------------------------------------
                // For those browsers that don't support console.log() define a dummy version to prevent crashes.
                //--------------------------------------------------------------------------------------------------
                (function () {
                    if (typeof console !== "object") {
                        console = {log: function(){}};
                    }
                }());

                //--------------------------------------------------------------------------------------------------
                // Creates and returns canvas.
                //--------------------------------------------------------------------------------------------------
                function createCanvas() {
                    var targetDiv = document.getElementById("targetCanvasDiv");
                    var canvas = document.createElement('canvas');
                    canvas.setAttribute("width",  640);
                    canvas.setAttribute("height", 200);
                    targetDiv.appendChild(canvas);

                    // older internet explorer support for canvas... must have excanvas.min.js present and referenced
                    if (typeof(G_vmlCanvasManager) != 'undefined') {
                        canvas = G_vmlCanvasManager.initElement(canvas);
                    }
                    return canvas;
                }

                //--------------------------------------------------------------------------------------------------
                // Main entry point.
                //--------------------------------------------------------------------------------------------------
                function init() {
                    var canvas = createCanvas();
                    var ctx = canvas.getContext('2d');

                    var mazeIdTextFld = document.getElementById("mazeId");
                    var mazeId = mazeIdTextFld.value;

                    var textAreaBox = new TextAreaBox(ctx, "black", "#aaaaaa",
                        MazeGlobals.PROJECTIONPLANEWIDTH, MazeGlobals.TEXTBOXWIDTH, MazeGlobals.TEXTBOXHEIGHT);
                    textAreaBox.dumpText('test test test');

                    if (ctx.createImageData == null) {
                        textAreaBox.dumpError('Please upgrade your browser. Sorry, your browser is out of date for this viewer to function properly.');
                        return;
                    }




                /***
                    var iniFile = new IniFile(mazeId, "MazeConfig.ini");
                    iniFile.loadFile(function(statusGood, message) {
                        if (statusGood) console.log('Maze.html: MazeConfig.ini successfully loaded.');
                        else {
                            textAreaBox.dumpError('error: ' + message);
                            return;
                        }
                    });
                ***/

                    var mapData = new MapData(document, mazeId, textAreaBox);
                    mapData.loadDataFile(function(statusGood, message) {
                        if (statusGood) console.log('Maze.html: Map Data file successfully loaded.');
                        else {
                            textAreaBox.dumpError('error unable to load Map Data file: ' + message);
                            return;
                        }
                        mapData.loadAssociatedImages(function(statusGood2, message2) {
                            if (statusGood2) console.log('Maze.html: successfully loaded associated image files');
                            else {
                                textAreaBox.dumpError('error unable to load associated images: ' + message2);
                                return;
                            }
                        });


                        var mazeConfig = new MazeConfig(document, mazeId, textAreaBox, mapData.mapHeight, mapData.mapWidth);
                        mazeConfig.loadConfigFile(function(){
                            maze = new Maze(ctx, mapData, mazeConfig);
                            window.addEventListener('keydown', doKeyDown, true);
                        });



                    });

                    return setInterval(render, 100);

                }

                //--------------------------------------------------------------------------------------------------
                // On key down event.
                //--------------------------------------------------------------------------------------------------
                function doKeyDown(evt) {
                	if (maze == null) return;
                    switch (evt.keyCode) {
                        case 38: // Up arrow was pressed
                        	maze.moveForward();
                            maze.renderOneFrame();
                            break;
                        case 40: // Down arrow was pressed
                        	maze.moveBackward();
                            maze.renderOneFrame();
                            break;
                        case 37: // Left arrow was pressed
                        	maze.rotateLeft();
                            maze.renderOneFrame();
                            break;
                        case 39: // Right arrow was pressed
                        	maze.rotateRight();
                            maze.renderOneFrame();
                            break;
                    }
                }

                //--------------------------------------------------------------------------------------------------
                // Render a frame.
                //--------------------------------------------------------------------------------------------------
                function render() {
                    if (maze != null) maze.renderOneFrame();
                }

                window.addEventListener('keydown', doKeyDown, true);
            </script>

            http://stackoverflow.com/questions/12273451/how-to-fix-delay-in-javascript-keydown

        </section>
    </body>
</html>



